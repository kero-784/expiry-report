<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Modern Trendy Styles - Enhanced CSS for better UI */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modern font */
            margin: 0;
            padding: 0;
            background-color: #f4f7f9; /* Light background */
            color: #333; /* Darker text for readability */
        }

        #currentDateDisplay {
            text-align: right;
            padding: 10px 20px;
            font-size: 0.9em;
            color: #777;
        }

        h1 {
            text-align: center;
            color: #2c3e50; /* Darker heading color */
            margin-bottom: 20px;
            padding: 20px 0;
            background-color: #fff; /* White background for header */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Subtle shadow */
        }

        .container {
            background-color: #fff;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px; /* Limit container width */
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* More pronounced shadow */
        }

        .database-section-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        }

        .database-section-container button {
            margin: 10px;
        }


        h2 {
            color: #3498db; /* Accent color for section titles */
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
        }

        input[type="text"],
        input[type="file"] {
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: calc(100% - 22px); /* Adjust width to account for padding and border */
            box-sizing: border-box; /* Ensure padding and border are inside the element's total width */
        }

        button {
            background-color: #3498db; /* Primary button color */
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease; /* Smooth hover transition */
            margin: 5px; /* Add some margin to buttons */
        }

        button:hover {
            background-color: #2980b9; /* Darker shade on hover */
        }

        button:disabled {
            background-color: #95a5a6; /* Greyed out for disabled state */
            cursor: not-allowed;
        }

        #searchResultTable, #recordTable, #popupTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden; /* For rounded corners on table */
        }

        #searchResultTable thead, #recordTable thead, #popupTable thead {
            background-color: #34495e; /* Darker header background */
            color: white;
            font-weight: bold;
        }

        #searchResultTable th, #recordTable th, #popupTable th,
        #searchResultTable td, #recordTable td, #popupTable td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        #searchResultTable tbody tr:nth-child(even), #recordTable tbody tr:nth-child(even), #popupTable tbody tr:nth-child(even) {
            background-color: #f9f9f9; /* Light background for even rows */
        }

        #searchResultTable tbody tr:hover, #recordTable tbody tr:hover, #popupTable tbody tr:hover {
            background-color: #f0f0f0; /* Slightly darker on hover */
        }

        #expiryInputs {
            margin-top: 15px;
            display: flex;
            flex-direction: column; /* Stack expiry inputs vertically */
        }

        .expiry-input-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center; /* Align items vertically in row */
        }

        .expiry-input-row label {
            margin-right: 10px;
            min-width: 80px; /* Ensure labels are aligned */
            display: inline-block;
        }

        .expiry-input-row input[type="date"],
        .expiry-input-row input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            flex-grow: 1; /* Allow inputs to take available space */
        }

        #dataPopup {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center; /* Center content horizontally */
            align-items: center; /* Center content vertically */
        }

        #dataPopupContent {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            position: relative; /* For close button positioning */
        }

        .closePopup {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .closePopup:hover,
        .closePopup:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Responsive adjustments */
        @media screen and (max-width: 768px) {
            .container {
                margin: 15px;
                padding: 15px;
            }

            .database-section-container {
                flex-direction: column; /* Stack buttons vertically on smaller screens */
                align-items: stretch; /* Make buttons full width */
            }

            .database-section-container button {
                width: 100%;
                margin: 5px 0;
            }

            .expiry-input-row {
                flex-direction: column; /* Stack labels and inputs vertically on smaller screens */
                align-items: stretch;
            }

            .expiry-input-row label {
                margin-bottom: 5px;
                text-align: left; /* Align labels to the left */
            }

            .expiry-input-row input[type="date"],
            .expiry-input-row input[type="number"] {
                margin-bottom: 10px;
                margin-right: 0; /* Remove right margin */
                width: calc(100% - 16px); /* Adjust width for padding and border */
            }

            #dataPopupContent {
                width: 95%; /* Wider popup on smaller screens */
                margin: 10% auto;
            }
        }

        /* Alert Message Style (using a simple approach - can be enhanced) */
        .alert-message {
            position: fixed; /* Stay in place */
            z-index: 2; /* Sit on top of everything */
            left: 50%;
            bottom: 20px; /* Distance from the bottom */
            transform: translateX(-50%); /* Center horizontally */
            background-color: #2ecc71; /* Success color */
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0; /* Initially hidden */
            visibility: hidden; /* Initially hidden */
            transition: opacity 0.5s, visibility 0.5s; /* Fade in animation */
            text-align: center;
        }

        .alert-message.error {
            background-color: #e74c3c; /* Error color */
        }

        .alert-message.show {
            opacity: 1; /* Fully visible */
            visibility: visible; /* Fully visible */
        }


    </style>
</head>
<body>
    <div id="currentDateDisplay"></div>
    <h1><i class="fas fa-warehouse"></i> Inventory Manager</h1>

    <div class="container database-section-container">
        <h2><i class="fas fa-database"></i> Database Management</h2>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
        <button id="importButton" title="Import Data"><i class="fas fa-upload"></i> Import from File</button>
        <button id="importGoogleSheetButton" title="Import Data from Google Sheet"><i class="fas fa-cloud-download-alt"></i> Import from Google Sheet</button>
        <button id="viewDataButton" title="View Imported Data" disabled><i class="fas fa-table"></i> View Data</button>
        <button id="clearDatabaseButton" title="Clear Database"><i class="fas fa-trash-alt"></i> Clear DB</button>
    </div>

    <div class="container">
        <h2><i class="fas fa-search"></i> Search Inventory</h2>
        <input type="text" id="searchBarcodeInput" placeholder="Search by Barcode">
        <button id="searchButton" title="Search" disabled><i class="fas fa-search"></i> Search</button>
    </div>

      <table id="searchResultTable" style="display: none;">
        <thead>
           <!-- Headers will be dynamically added here -->
        </thead>
        <tbody id="searchResultTableBody">
           <!-- Search results will be added here-->
        </tbody>
      </table>

    <div class="container">
        <h2><i class="fas fa-calendar-plus"></i> Add Expiry & Save Entry</h2>
        <div class="container" style="margin-bottom: 15px; padding: 0; box-shadow: none; border-radius: 0;">  <!-- Container for Add Expiry and Clear Fields -->
            <button id="addExpiryButton" title="Add Expiry Fields"><i class="fas fa-plus-circle"></i> Add Expiry</button>
            <button id="clearFieldsButton" title="Clear Input Fields"><i class="fas fa-broom"></i> Clear Fields</button>
        </div>

        <div id="expiryInputs">
            <!-- Dynamic Expiry Inputs will be placed here -->
        </div>

        <div class="container" style="margin-bottom: 0px; padding: 0; box-shadow: none; border-radius: 0; margin-bottom: 15px;">  <!-- Container for Save Entry -->
            <button id="saveButton" disabled title="Save Entry"><i class="fas fa-save"></i> Save Entry</button>
        </div>
    </div>


    <div class="container">
        <h2><i class="fas fa-list-alt"></i> Inventory Records</h2>
        <table id="recordTable">
            <thead>

            </thead>
            <tbody id="recordTableBody">
                <!-- Entered records will be displayed here -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="100%" style="text-align: right; padding: 15px;">
                        <button id="exportButton" title="Export Saved Data"><i class="fas fa-download"></i> Export Data</button>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>


    <div id="dataPopup" style="display:none">
        <div id="dataPopupContent">
         <span class="closePopup">×</span>
         <table id="popupTable"></table>
        </div>
    </div>

    <div id="alertMessage" class="alert-message" role="alert">
        <!-- Alert messages will be placed here -->
    </div>


    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Include crypto-js library for client-side encryption (if needed - security limitations apply) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> -->
    <script>
         // --- Constants ---
        const BARCODE_HEADER_KEY = 'barcode';
        const NAME_HEADER_KEY = 'name';
        const EXPIRY_DATE_PREFIX = 'expiryDate';
        const QUANTITY_PREFIX = 'quantity';
        const RECORD_TIME_KEY = 'recordTime';
        const ENTERED_RECORDS_STORAGE_KEY = 'enteredRecords';
        const BARCODE_HEADER_STORAGE_KEY = 'barcodeHeader';
        const NAME_HEADER_STORAGE_KEY = 'nameHeader';
        const CURRENT_DATE_STORAGE_KEY = 'currentDate';
        const DATABASE_STORAGE_KEY = 'inventoryDatabase'; // Key for localStorage database
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRBHjQ-Gsb4AFkplCr5sHTme_hAXGzr51-2bhCfrw6rjUaAg5TkRHU8COSYPE9BaA/pub?output=csv"; // **IMPORTANT: REPLACE WITH YOUR ACTUAL GOOGLE SHEET CSV URL HERE!**
        // const encryptionKey = "YourSecretEncryptionKey"; // **Replace with a strong, randomly generated key if using encryption - Keep this secret!**


        // Global variables - same global variables as before
        let database = [];
        let currentItem = null;
        let enteredRecords = [];
        let headerMap = {};
        let barcodeHeader = '';
        let nameHeader = '';
        let expiryHeaderCount = 0;
        const dbName = "inventoryDB"; // Not used anymore for localStorage
        const dbStoreName = "inventoryStore"; // Not used anymore for localStorage
        let cachedRecordHeaders = null; // Variable to cache record table headers


        // Get HTML elements - same get elements as before
        const fileInput = document.getElementById('fileInput');
        const importButton = document.getElementById('importButton');
        const importGoogleSheetButton = document.getElementById('importGoogleSheetButton');
        const searchBarcodeInput = document.getElementById('searchBarcodeInput');
        const searchButton = document.getElementById('searchButton');
         const searchResultTable = document.getElementById('searchResultTable');
         const searchResultTableBody = document.getElementById('searchResultTableBody')
        const expiryInputs = document.getElementById('expiryInputs');
        const addExpiryButton = document.getElementById('addExpiryButton');
        const saveButton = document.getElementById('saveButton');
        const clearFieldsButton = document.getElementById('clearFieldsButton');
        const recordTableBody = document.getElementById('recordTableBody');
        const exportButton = document.getElementById('exportButton');
         const viewDataButton = document.getElementById('viewDataButton');
        const clearDatabaseButton = document.getElementById('clearDatabaseButton');
        const dataPopup = document.getElementById('dataPopup');
        const dataPopupContent = document.getElementById('dataPopupContent');
          const currentDateDisplay = document.getElementById('currentDateDisplay');
        const closePopup = document.querySelector('.closePopup');
         const alertMessage = document.getElementById('alertMessage');


          function getCurrentDateTime(){
              const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
             const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

              return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`
          }


        async function loadDataFromLocalStorage() {
             let storedEnteredRecords = localStorage.getItem(ENTERED_RECORDS_STORAGE_KEY);
             const storedBarcodeHeader = localStorage.getItem(BARCODE_HEADER_STORAGE_KEY);
            const storedNameHeader = localStorage.getItem(NAME_HEADER_STORAGE_KEY);
             let storedCurrentDate = localStorage.getItem(CURRENT_DATE_STORAGE_KEY);
             const storedDatabase = localStorage.getItem(DATABASE_STORAGE_KEY); // Load database from localStorage


            if (storedEnteredRecords) enteredRecords = JSON.parse(storedEnteredRecords);
            if (storedBarcodeHeader) barcodeHeader = storedBarcodeHeader;
             if(storedNameHeader) nameHeader = storedNameHeader;
              if(!storedCurrentDate){
                    localStorage.setItem(CURRENT_DATE_STORAGE_KEY, getCurrentDateTime());
                    storedCurrentDate = localStorage.getItem(CURRENT_DATE_STORAGE_KEY)
                 }
             if (storedDatabase) database = JSON.parse(storedDatabase); // Load database from localStorage

               currentDateDisplay.textContent = `Current Date: ${storedCurrentDate}`;
            renderEnteredRecords();
            updateViewButtonState(); // Update view button state based on database


         }

         function updateViewButtonState(){
            if(database.length > 0){
                viewDataButton.disabled = false;
                searchButton.disabled = false;
             } else {
                viewDataButton.disabled = true;
                searchButton.disabled = true;
             }
         }


         // --- REMOVED IndexedDB Functions: openDatabase, storeDatatoIndexedDB, getDataFromIndexedDB, getAllDataFromIndexedDB ---


        // Import Functionality (Phase 2) - same as before
        importButton.addEventListener('click', () => {
            fileInput.click();
        });

        importGoogleSheetButton.addEventListener('click', () => {
            fetchDataFromGoogleSheet(GOOGLE_SHEET_CSV_URL); // Use constant here
        });

        fileInput.addEventListener('change', handleFileImport);


        async function fetchDataFromGoogleSheet(url) {
            const directURL = url; // Use direct URL now

            try {
                const response = await fetch(directURL); // Use direct URL
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                if (parsedData && parsedData.data.length > 0) {
                    await processGoogleSheetCSVData(parsedData.headers, parsedData.data);
                    showAlert('Data imported from Google Sheet successfully!'); // Using showAlert
                     renderEnteredRecords();
                    updateViewButtonState();
                } else {
                    showAlert('No data found in Google Sheet or error parsing data.'); // Using showAlert
                     loadDataFromLocalStorage(); // Fallback to local storage load
                }
            } catch (error) {
                console.error("Error importing from Google Sheet:", error);
                showAlert('Failed to import data from Google Sheet. Please check the URL and ensure the sheet is published to the web as CSV. (CORS issue might exist if direct URL is not configured for CORS)', true); // Using showAlert for errors
                loadDataFromLocalStorage(); // Fallback to local storage load
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 1) return { headers: [], data: [] };

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',').map(cell => cell.trim());
                if(row.length > 0 && row[0] !== ""){
                   data.push(row);
                 }
            }

            return { headers: headers, data: data };
        }


        async function processGoogleSheetCSVData(headers, data) {
             if (headers.length === 0) {
                showAlert("Could not parse headers from Google Sheet CSV. Ensure the first row contains headers."); // Using showAlert
                return;
            }

             headers.forEach((header, index) => {
                if(header && header.toLowerCase().includes(BARCODE_HEADER_KEY)) {
                  barcodeHeader = header;
                }
                if(header && header.toLowerCase().includes(NAME_HEADER_KEY)){
                  nameHeader = header
                }
                 headerMap[header] = index;
            });

             if (!barcodeHeader) {
                 showAlert(`No '${BARCODE_HEADER_KEY}' column found in the Google Sheet CSV.`); // Using showAlert
                 return;
             }
             if (!nameHeader){
                 showAlert(`No '${NAME_HEADER_KEY}' column found in the Google Sheet CSV.`); // Using showAlert
                 return;
             }

            database = data;
            localStorage.setItem(DATABASE_STORAGE_KEY, JSON.stringify(database)); // Store database to localStorage
            localStorage.setItem(BARCODE_HEADER_STORAGE_KEY, barcodeHeader);
            localStorage.setItem(NAME_HEADER_STORAGE_KEY, nameHeader);

        }


        async function handleFileImport(event) {
             try {
                const file = event.target.files[0];
                if (!file) {
                    showAlert('No file selected!'); // Using showAlert
                    return;
                }

                const allowedFileTypes = ['.xlsx', '.xls'];
                const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                if (!allowedFileTypes.includes(fileExtension)) {
                    showAlert('Invalid file type. Please select an Excel file (.xlsx or .xls).'); // Using showAlert
                    return;
                }

                 const reader = new FileReader();
                 reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        let workbook;
                        try{
                            workbook = XLSX.read(data, { type: 'array' });
                        }catch(e){
                            console.error("Error parsing file:", e)
                            showAlert('Error parsing file, please check the file format!', true); // Using showAlert for errors
                            return;
                        }
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const range = XLSX.utils.decode_range(worksheet['!ref']);
                         if(range.e.r <1){
                            showAlert("File contains no data!"); // Using showAlert
                            return;
                        }
                        const excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (!excelData || excelData.length === 0) {
                            showAlert('File is empty or unreadable!'); // Using showAlert
                            return;
                        }

                        const headers = excelData[0];
                        headers.forEach((header, index) => {
                            if(header && header.toLowerCase().includes(BARCODE_HEADER_KEY)) {
                              barcodeHeader = header;
                            }
                            if(header && header.toLowerCase().includes(NAME_HEADER_KEY)){
                              nameHeader = header
                            }
                             headerMap[header] = index;
                        });

                         if (!barcodeHeader) {
                             showAlert(`No '${BARCODE_HEADER_KEY}' column found in the file.`); // Using showAlert
                             return;
                         }
                         if (!nameHeader){
                             showAlert(`No '${NAME_HEADER_KEY}' column found in the file.`); // Using showAlert
                             return;
                         }


                        database = excelData.slice(1);
                        localStorage.setItem(DATABASE_STORAGE_KEY, JSON.stringify(database)); // Store database to localStorage
                        localStorage.setItem(BARCODE_HEADER_STORAGE_KEY, barcodeHeader);
                        localStorage.setItem(NAME_HEADER_STORAGE_KEY, nameHeader);


                            showAlert('Data imported successfully!'); // Using showAlert
                            renderEnteredRecords();
                            updateViewButtonState();


                    } catch (e) {
                       console.error("Error parsing file:", e)
                        showAlert('Error parsing file, please check the file format!', true); // Using showAlert for errors
                    }
                 };

                 reader.onerror = (e) =>{
                     console.error("Error reading file:", e)
                        showAlert('Error reading file, please check the file format!', true); // Using showAlert for errors
                };

                 reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error during import:", error);
                showAlert('An unexpected error occurred during file import.', true); // Using showAlert for errors
            }
        }

       // Search Functionality (Phase 3) - same search functionality as before
        searchButton.addEventListener('click', () => {
            const barcode = searchBarcodeInput.value.trim();

            if(!barcode){
                showAlert('Please enter a barcode to search!'); // Using showAlert
                return;
            }
            if(database.length === 0){
                showAlert('No data imported, Please import excel sheet or google sheet.'); // Using showAlert
                return;
            }

            const foundItem = database.find(item => item[headerMap[barcodeHeader]] === barcode);

            if (foundItem) {
              currentItem = foundItem;

                 renderSearchResultTable(foundItem);
                addExpiryEntry();
                saveButton.disabled = false;
            } else {
               showAlert("No item found with this barcode!"); // Using showAlert

              currentItem = null;
                searchResultTable.style.display = 'none';
              expiryInputs.innerHTML = '';
              saveButton.disabled = true;
            }
        });

         function renderSearchResultTable(foundItem) { // same render search result table function as before
           const searchResultTableHead = searchResultTable.querySelector('thead');
           searchResultTableHead.innerHTML = '';
           const headerRow = document.createElement('tr');
          for (const header in headerMap) {
           const th = document.createElement('th');
           th.textContent = header;
           headerRow.appendChild(th);
          }
           searchResultTableHead.appendChild(headerRow)

             searchResultTableBody.innerHTML = '';

               const row = document.createElement('tr');
             for (const header in headerMap) {
               const td = document.createElement('td');
               td.textContent = foundItem[headerMap[header]];
               row.appendChild(td)
              }

             searchResultTableBody.appendChild(row);
           searchResultTable.style.display = 'block';
        }

        // Expiry Date Management (Phase 4) - same expiry date management as before
        addExpiryButton.addEventListener('click', addExpiryEntry);

        function addExpiryEntry() {
            const entryCount = expiryInputs.children.length;
            if (entryCount >= 5) {
                showAlert("Maximum 5 expiry entries allowed.");
                return;
            }

            const expiryRow = document.createElement('div');
            expiryRow.className = 'expiry-input-row';

            const label = document.createElement('label');
            label.textContent = `Expiry ${entryCount + 1}:`;
            expiryRow.appendChild(label);

            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.id = `${EXPIRY_DATE_PREFIX}${expiryHeaderCount}`;
            dateInput.name = `${EXPIRY_DATE_PREFIX}${expiryHeaderCount}`;
            expiryRow.appendChild(dateInput);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.id = `${QUANTITY_PREFIX}${expiryHeaderCount}`;
            quantityInput.name = `${QUANTITY_PREFIX}${expiryHeaderCount}`;
            quantityInput.placeholder = 'Quantity';
            quantityInput.min = '1';
            expiryRow.appendChild(quantityInput);


            expiryInputs.appendChild(expiryRow);
            expiryHeaderCount++;
        }


          function isValidDate(dateString){
          const regex = /^\d{4}-\d{2}-\d{2}$/; // YYYY-MM-DD format
            if (!regex.test(dateString)) return false;

            const date = new Date(dateString);
            const timestamp = date.getTime();

            if (typeof timestamp !== 'number' || isNaN(timestamp)) return false;

            return date.toISOString().startsWith(dateString);
        }


        // Save Entry (Phase 5) - Main Save Button (Now Visible and used for all entries) - same save entry function as before
          saveButton.addEventListener('click', () => {
            if (!currentItem) {
                showAlert("No item selected to save entry.");
                return;
            }

            let recordEntry = {
                [BARCODE_HEADER_KEY]: currentItem[headerMap[barcodeHeader]],
                [NAME_HEADER_KEY]: currentItem[headerMap[nameHeader]],
                [RECORD_TIME_KEY]: getCurrentDateTime()
            };
            let hasExpiry = false;


            for (let i = 0; i < expiryInputs.children.length; i++) {
                const dateInput = expiryInputs.children[i].querySelector(`input[type="date"]`);
                const quantityInput = expiryInputs.children[i].querySelector(`input[type="number"]`);

                const expiryDate = dateInput.value;
                const quantity = quantityInput.value;


                if (expiryDate && quantity) {
                    if(!isValidDate(expiryDate)){
                       showAlert(`Invalid date format for Expiry ${i + 1}. Please use YYYY-MM-DD format.`);
                        return;
                    }
                    hasExpiry = true;
                    recordEntry[`${EXPIRY_DATE_PREFIX}${i + 1}`] = expiryDate;
                    recordEntry[`${QUANTITY_PREFIX}${i + 1}`] = quantity;
                } else if (expiryDate || quantity) {
                    showAlert(`Please fill both date and quantity for Expiry ${i + 1}.`);
                    return;
                }
            }

             if (!hasExpiry) {
                showAlert("Please add at least one expiry date and quantity.");
                return;
             }


            enteredRecords.push(recordEntry);
            localStorage.setItem(ENTERED_RECORDS_STORAGE_KEY, JSON.stringify(enteredRecords));
            renderEnteredRecords();
            clearFields();
            searchBarcodeInput.value = '';
            searchResultTable.style.display = 'none';
            saveButton.disabled = true;
            currentItem = null;
            showAlert("Entry saved successfully!");


          });

        // Clear Functions (Phase 6) - same clear functions as before
        clearFieldsButton.addEventListener('click', clearFields);

        function clearFields() {
            expiryInputs.innerHTML = '';
            expiryHeaderCount = 0;
            saveButton.disabled = true;
            searchResultTable.style.display = 'none';
            searchBarcodeInput.value = '';
            currentItem = null;
        }

        clearDatabaseButton.addEventListener('click', clearDatabase);

          async function clearDatabase() {
            const confirmClear = confirm("Are you sure you want to clear the entire database? This action cannot be undone.");
            if (!confirmClear) {
                return; // Do nothing if user cancels
            }

           database = [];
           currentItem = null;
           enteredRecords = [];
           headerMap = {};
           barcodeHeader = '';
           nameHeader = '';
           expiryHeaderCount = 0;
           cachedRecordHeaders = null; // Clear cached headers

           recordTableBody.innerHTML = '';
           searchBarcodeInput.value = '';
           clearFields();
           saveButton.disabled = true;
           searchResultTable.style.display = 'none';
           localStorage.removeItem(ENTERED_RECORDS_STORAGE_KEY);
           localStorage.removeItem(BARCODE_HEADER_STORAGE_KEY);
           localStorage.removeItem(NAME_HEADER_STORAGE_KEY);
           localStorage.removeItem(DATABASE_STORAGE_KEY); // Clear database from localStorage
           updateViewButtonState();
           showAlert("Database has been cleared!"); // Using showAlert

         }


        // Render Table & List Box (Phase 7) - same render table and list box function as before


           function renderEnteredRecords() {
            recordTableBody.innerHTML = '';
            if (enteredRecords.length === 0) {
                recordTableBody.innerHTML = '<tr><td colspan="100%" style="text-align:center; padding: 15px;">No records entered yet.</td></tr>';
                return;
            }

            if (!cachedRecordHeaders) {
                const headers = new Set();
                headers.add(BARCODE_HEADER_KEY);
                headers.add(NAME_HEADER_KEY);
                headers.add(RECORD_TIME_KEY);
                enteredRecords.forEach(record => {
                    Object.keys(record).forEach(key => {
                        if (key.startsWith(EXPIRY_DATE_PREFIX) || key.startsWith(QUANTITY_PREFIX)) {
                            headers.add(key);
                        }
                    });
                });
                cachedRecordHeaders = Array.from(headers);

                const recordTableHead = recordTable.querySelector('thead');
                recordTableHead.innerHTML = '';
                const headerRow = document.createElement('tr');
                cachedRecordHeaders.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                recordTableHead.appendChild(headerRow);
            }


            enteredRecords.forEach(record => {
                const row = document.createElement('tr');
                cachedRecordHeaders.forEach(headerText => {
                    const td = document.createElement('td');
                    td.textContent = record[headerText] || '-';
                    row.appendChild(td);
                });
                recordTableBody.appendChild(row);
            });
        }


        async function renderDataList(){ // Modified to load data from localStorage
             const popupTable = document.getElementById('popupTable');
            popupTable.innerHTML = '';

            const headers = Object.keys(headerMap);
            const headerRow = document.createElement('tr');
            headers.forEach(headerText => {
              const th = document.createElement('th');
              th.textContent = headerText;
              headerRow.appendChild(th);
            });
            popupTable.appendChild(headerRow);

            const currentDatabase = database; // Use database from localStorage directly

                currentDatabase.forEach(row => {
                  const tr = document.createElement('tr');
                  for (const header in headerMap) {
                    const td = document.createElement('td');
                    td.textContent = row[headerMap[header]];
                    tr.appendChild(td);
                  }
                  popupTable.appendChild(tr);
                });


            dataPopup.style.display = 'flex';
        }


        // Export Data (Phase 8) - same export data function as before
        exportButton.addEventListener('click', () => {
            if (enteredRecords.length === 0) {
                showAlert("No data to export!");
                return;
            }

            const filename = 'inventory_records.xlsx';
            const ws_name = "Inventory Records";

            const wb = XLSX.utils.book_new();
            const ws_data = [cachedRecordHeaders, ...enteredRecords.map(record => cachedRecordHeaders.map(header => record[header] || ''))];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, ws_name);
            XLSX.writeFile(wb, filename);
        });

       viewDataButton.addEventListener('click', () =>{ // same view data button function as before
            if(database.length === 0){
               showAlert("Please import excel sheet or google sheet to display data!"); // Using showAlert
                return;
            }
           renderDataList();
        });


        closePopup.addEventListener('click', () => { // same close popup function as before
            dataPopup.style.display = "none";
        });

          window.addEventListener('click', (event) => { // same window click event listener as before
            if (event.target == dataPopup) {
                dataPopup.style.display = "none";
            }
        });

        searchBarcodeInput.addEventListener('input', (e) => {
            if(!e.target.value.trim()){
                searchResultTable.style.display = 'none'; // Hide table when input is cleared
            }
        });


        function showAlert(message, isError = false) { // Centralized alert function
            alertMessage.textContent = message;
            alertMessage.className = `alert-message ${isError ? 'error' : 'success'} show`;

            setTimeout(() => {
                alertMessage.classList.remove('show');
                setTimeout(() => {
                    alertMessage.textContent = ''; // Clear text after fade out
                    alertMessage.className = 'alert-message'; // Reset class
                }, 500); // Wait for the fade out transition
            }, 3000); // Duration message is shown (3 seconds)
        }

        // --- Decryption Example Functions (if you are using client-side encryption - include crypto-js library in HTML) ---
        // function encryptData(data) {
        //     return CryptoJS.AES.encrypt(JSON.stringify(data), encryptionKey).toString();
        // }

        // function decryptData(encryptedData) {
        //     try {
        //         const bytes = CryptoJS.AES.decrypt(encryptedData, encryptionKey);
        //         return JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
        //     } catch (e) {
        //         console.error("Decryption error:", e);
        //         return null; // Or handle decryption failure appropriately
        //     }
        // }

        async function autoLoadDatabaseFromGoogleSheet() { // Renamed for clarity and to indicate Google Sheet source
            let databaseURL = GOOGLE_SHEET_CSV_URL; // Use the constant

            console.log("Auto-loading database from Google Sheet CSV URL:", databaseURL);

            try {
                const response = await fetch(databaseURL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const parsedData = parseCSV(csvText); // Reuse your parseCSV function from Inventory Manager

                if (parsedData && parsedData.data.length > 0) { // Use .data for your parseCSV output structure
                    await processGoogleSheetCSVData(parsedData.headers, parsedData.data); // Reuse your processGoogleSheetCSVData
                    showAlert('Database auto-loaded from Google Sheet successfully!'); // Use showAlert
                } else {
                    showAlert('No data found in Google Sheet or error parsing data during auto-load.'); // Use showAlert
                }
            } catch (error) {
                console.error('Error auto-loading database from Google Sheet:', error);
                showAlert(`Error auto-loading database from Google Sheet: ${error.message}`, true); // Use showAlert for errors
                // Fallback to loading from local storage if auto-load fails
                loadDataFromLocalStorage();
            }
        }


        async function init() {
            await autoLoadDatabaseFromGoogleSheet(); // Try to auto-load from Google Sheet first
            await loadDataFromLocalStorage(); // Then load from localStorage for other data
        }


        window.onload = function () {
            init(); // Call init which will handle auto-loading and loading from storage
        };
    </script>
</body>
</html>
