<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Modern Trendy Styles - CSS  UPDATED for better UI View */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            color: #495057;
            line-height: 1.6;
        }

        #currentDateDisplay {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 0.9em;
            color: #6c757d;
        }

        h1 {
            text-align: center;
            color: #343a40;
            font-size: 2.5em; /* Increased font size for heading */
            margin-bottom: 20px;
            animation: fadeIn 1s ease-out;
        }

        .container {
            text-align: center;
            margin-bottom: 25px;
        }

        .database-section-container {
            border: 1px solid #dee2e6; /* Added border for better separation */
            padding: 20px;
            border-radius: 12px; /* More rounded corners */
            margin-bottom: 25px;
            background-color: #fff;
            box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1); /* Increased shadow intensity */
            animation: slideUp 0.8s ease-out;
        }

        .database-section-container h2 {
            font-size: 1.8em; /* Increased section heading size */
            color: #343a40;
            margin-top: 0;
            margin-bottom: 20px; /* Increased margin bottom */
        }

        button {
            margin: 5px;
            padding: 12px 24px; /* Increased button padding */
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px; /* More rounded button corners */
            font-size: 1.1em; /* Increased button font size */
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); /* Increased button shadow */
        }

        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2); /* Increased shadow on hover */
        }

        button:active {
            transform: translateY(0); /* No lift on active */
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); /* Shadow back to normal on active */
        }

        .remove-button {
            background-color: #dc3545;
        }

        .remove-button:hover {
            background-color: #bd2130;
        }

        .save-expiry-button {
            background-color: #28a745;
        }

        .save-expiry-button:hover {
            background-color: #1e7e34;
        }

        .add-expiry-button-inline {
            background-color: #ffc107;
            color: #fff;
        }

        .add-expiry-button-inline:hover {
            background-color: #e0a800;
        }


        input[type="text"], input[type="number"] {
            padding: 12px; /* Increased input padding */
            margin: 5px;
            border: 1px solid #ced4da;
            border-radius: 8px; /* More rounded input corners */
            font-size: 1.1em; /* Increased input font size */
            transition: border-color 0.3s ease, box-shadow 0.3s ease; /* Added box-shadow transition */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06); /* Subtle inner shadow */
        }

        input[type="text"]:focus, input[type="number"]:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.3); /* More pronounced focus shadow */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.15); /* Increased table shadow */
            border-radius: 12px; /* More rounded table corners */
            overflow-x: auto;
            animation: slideLeft 0.8s ease-out;
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 14px 18px; /* Increased cell padding */
            text-align: left;
            font-size: 1em; /* Increased cell font size */
            white-space: nowrap;
        }

        th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 500;
            text-transform: uppercase; /* Uppercase table headers */
            letter-spacing: 0.03em; /* Slight letter spacing for headers */
        }

        .expiry-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        #dataPopup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            overflow: auto;
            animation: fadeIn 0.5s ease-out;
        }

        #dataPopupContent {
            background-color: #fff;
            padding: 35px; /* Increased popup content padding */
            border-radius: 15px; /* More rounded popup corners */
            box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.25); /* Increased popup shadow */
            overflow: auto;
            max-height: 90vh;
            max-width: 95vw; /* Increased max width for popup */
            position: relative;
        }

        .closePopup {
            position: absolute;
            top: 20px;
            right: 25px; /* Adjusted close button position */
            font-size: 28px; /* Increased close button size */
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .closePopup:hover {
            color: #343a40;
        }

        #popupTable {
            width: 100%;
            border-collapse: collapse;
            border-radius: 10px; /* Rounded corners for popup table */
            overflow: hidden; /* Ensure rounded corners are respected */
            box-shadow: 0 0 0.5rem rgba(0,0,0,0.1); /* Added subtle shadow for popup table */
            margin-bottom: 15px; /* Added margin bottom for popup table */
        }

        #popupTable th,
        #popupTable td {
            border: 1px solid #e0e0e0; /* Lighter border for popup table */
            padding: 14px 18px; /* Increased padding for popup table cells */
            text-align: left;
            font-size: 1em; /* Font size for popup table cells */
        }

        #popupTable th {
            background-color: #f0f0f0; /* Lighter background for popup table headers */
            color: #333; /* Darker color for popup table header text */
            font-weight: 600; /* Slightly bolder font for popup table headers */
        }


        #searchResultTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            overflow-x: auto;
            animation: slideRight 0.8s ease-out;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); /* Added shadow for search result table */
            border-radius: 8px; /* Rounded corners for search result table */
            overflow: hidden; /* Ensure rounded corners are respected */
        }

        #searchResultTable th, #searchResultTable td{
            border: 1px solid #e0e0e0; /* Lighter border for search result table */
            padding: 12px 15px;
            white-space: nowrap;
        }

        /* Animations - same animations as before */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideLeft {
            from { transform: translateX(-30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }


        /* Responsive adjustments - same responsive styles as before */
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            h1 {
                font-size: 2em; /* Adjusted heading size for smaller screens */
                margin-bottom: 15px;
            }
            .container {
                margin-bottom: 20px;
            }
            .database-section-container {
                padding: 15px;
                margin-bottom: 20px;
                border-radius: 10px; /* Adjusted container corner radius for smaller screens */
            }
            .database-section-container h2 {
                font-size: 1.5em; /* Adjusted section heading size for smaller screens */
                margin-bottom: 12px;
            }
            button, input[type="text"], input[type="number"] {
                font-size: 1em; /* Adjusted button and input font size for smaller screens */
                padding: 10px 18px; /* Adjusted button and input padding for smaller screens */
                margin: 4px;
                border-radius: 7px; /* Adjusted button and input corner radius for smaller screens */
            }
            th, td {
                font-size: 0.9em; /* Adjusted cell font size for smaller screens */
                padding: 10px;
            }
            #currentDateDisplay {
                top: 15px;
                left: 15px;
                font-size: 0.8em;
            }
            #dataPopupContent {
                padding: 25px; /* Adjusted popup content padding for smaller screens */
                border-radius: 12px; /* Adjusted popup corner radius for smaller screens */
            }
            .closePopup {
                top: 10px;
                right: 15px; /* Adjusted close button position for smaller screens */
                font-size: 22px; /* Adjusted close button size for smaller screens */
            }
        }
    </style>
</head>
<body>
    <div id="currentDateDisplay"></div>
    <h1><i class="fas fa-warehouse"></i> Inventory Manager</h1>

    <div class="container database-section-container">
        <h2><i class="fas fa-database"></i> Database Management</h2>
        <input type="file" id="fileInput" accept=".xlsx, .xls" style="display:none">
        <button id="importButton" title="Import Data"><i class="fas fa-upload"></i> Import from File</button>
        <button id="importGoogleSheetButton" title="Import Data from Google Sheet"><i class="fas fa-cloud-download-alt"></i> Import from Google Sheet</button>
        <button id="viewDataButton" title="View Imported Data"><i class="fas fa-table"></i> View Data</button>
        <button id="clearDatabaseButton" title="Clear Database"><i class="fas fa-trash-alt"></i> Clear DB</button>
    </div>

    <div class="container">
        <input type="text" id="searchBarcodeInput" placeholder="Search by Barcode">
        <button id="searchButton" title="Search"><i class="fas fa-search"></i> Search</button>
    </div>

      <table id="searchResultTable" style="display: none;">
        <thead>
           <!-- Headers will be dynamically added here -->
        </thead>
        <tbody id="searchResultTableBody">
           <!-- Search results will be added here-->
        </tbody>
      </table>

    <div class="container" style="margin-bottom: 15px;">  <!-- Container for Add Expiry and Clear Fields -->
        <button id="addExpiryButton" title="Add Expiry Fields"><i class="fas fa-plus-circle"></i> Add Expiry</button>
        <button id="clearFieldsButton" title="Clear Input Fields"><i class="fas fa-broom"></i> Clear Fields</button>
    </div>

    <div id="expiryInputs">
        <!-- Dynamic Expiry Inputs will be placed here -->
    </div>

    <div class="container" style="margin-bottom: 25px;">  <!-- Container for Save Entry -->
        <button id="saveButton" disabled title="Save Entry"><i class="fas fa-save"></i> Save Entry</button>
    </div>


    <table id="recordTable">
        <thead>

        </thead>
        <tbody id="recordTableBody">
            <!-- Entered records will be displayed here -->
        </tbody>
        <tfoot>
            <tr>
                <td colspan="100%" style="text-align: right; padding: 15px;">
                    <button id="exportButton" title="Export Saved Data"><i class="fas fa-download"></i> Export Data</button>
                </td>
            </tr>
        </tfoot>
    </table>


    <div id="dataPopup" style="display:none">
        <div id="dataPopupContent">
         <span class="closePopup">×</span>
         <table id="popupTable"></table>
        </div>
    </div>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK (if you intend to use Firebase, otherwise remove) -->
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>
    <script>
         // --- Constants ---
        const BARCODE_HEADER_KEY = 'barcode';
        const NAME_HEADER_KEY = 'name';
        const EXPIRY_DATE_PREFIX = 'expiryDate';
        const QUANTITY_PREFIX = 'quantity';
        const RECORD_TIME_KEY = 'recordTime';
        const ENTERED_RECORDS_STORAGE_KEY = 'enteredRecords';
        const BARCODE_HEADER_STORAGE_KEY = 'barcodeHeader';
        const NAME_HEADER_STORAGE_KEY = 'nameHeader';
        const CURRENT_DATE_STORAGE_KEY = 'currentDate';
        const DATABASE_STORAGE_KEY = 'inventoryDatabase'; // Key for localStorage database
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQYzK_xRvVNUdnuMZ6a5HEd1FHVmTSvTuKgEc20li1zTYdegkKYRiIo5w-fS5e45Q/pub?output=csv"; // **UPDATED with your provided Google Sheet URL!**
        // Firebase configuration (if you intend to use Firebase, otherwise remove)
        // const firebaseConfig = {
        //   apiKey: "YOUR_API_KEY",
        //   authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        //   projectId: "YOUR_PROJECT_ID",
        //   storageBucket: "YOUR_PROJECT_ID.appspot.com",
        //   messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        //   appId: "YOUR_APP_ID"
        // };
        // firebase.initializeApp(firebaseConfig);
        // const db = firebase.firestore(); // Get Firestore instance


        // Global variables - same global variables as before
        let database = [];
        let currentItem = null;
        let enteredRecords = [];
        let headerMap = {};
        let barcodeHeader = '';
        let nameHeader = '';
        let expiryHeaderCount = 0;
        const dbName = "inventoryDB"; // Not used anymore for localStorage
        const dbStoreName = "inventoryStore"; // Not used anymore for localStorage
        let cachedRecordHeaders = null; // Variable to cache record table headers


        // Get HTML elements - same get elements as before
        const fileInput = document.getElementById('fileInput');
        const importButton = document.getElementById('importButton');
        const importGoogleSheetButton = document.getElementById('importGoogleSheetButton');
        const searchBarcodeInput = document.getElementById('searchBarcodeInput');
        const searchButton = document.getElementById('searchButton');
         const searchResultTable = document.getElementById('searchResultTable');
         const searchResultTableBody = document.getElementById('searchResultTableBody')
        const expiryInputs = document.getElementById('expiryInputs');
        const addExpiryButton = document.getElementById('addExpiryButton');
        const saveButton = document.getElementById('saveButton');
        const clearFieldsButton = document.getElementById('clearFieldsButton');
        const recordTableBody = document.getElementById('recordTableBody');
        const exportButton = document.getElementById('exportButton');
         const viewDataButton = document.getElementById('viewDataButton');
        const clearDatabaseButton = document.getElementById('clearDatabaseButton');
        const dataPopup = document.getElementById('dataPopup');
        const dataPopupContent = document.getElementById('dataPopupContent');
          const currentDateDisplay = document.getElementById('currentDateDisplay');
        const closePopup = document.querySelector('.closePopup');


          function getCurrentDateTime(){
              const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
             const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

              return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`
          }


        async function loadDataFromLocalStorage() {
             let storedEnteredRecords = localStorage.getItem(ENTERED_RECORDS_STORAGE_KEY);
             const storedBarcodeHeader = localStorage.getItem(BARCODE_HEADER_STORAGE_KEY);
            const storedNameHeader = localStorage.getItem(NAME_HEADER_STORAGE_KEY);
             let storedCurrentDate = localStorage.getItem(CURRENT_DATE_STORAGE_KEY);
             const storedDatabase = localStorage.getItem(DATABASE_STORAGE_KEY); // Load database from localStorage


            if (storedEnteredRecords) enteredRecords = JSON.parse(storedEnteredRecords);
            if (storedBarcodeHeader) barcodeHeader = storedBarcodeHeader;
             if(storedNameHeader) nameHeader = storedNameHeader;
              if(!storedCurrentDate){
                    localStorage.setItem(CURRENT_DATE_STORAGE_KEY, getCurrentDateTime());
                    storedCurrentDate = localStorage.getItem(CURRENT_DATE_STORAGE_KEY)
                 }
             if (storedDatabase) database = JSON.parse(storedDatabase); // Load database from localStorage

               currentDateDisplay.textContent = `Current Date: ${storedCurrentDate}`;
            renderEnteredRecords();
            updateViewButtonState(); // Update view button state based on database


         }

         function updateViewButtonState(){
            if(database.length > 0){
                viewDataButton.disabled = false;
                searchButton.disabled = false;
             } else {
                viewDataButton.disabled = true;
                searchButton.disabled = true;
             }
         }


         // --- REMOVED IndexedDB Functions: openDatabase, storeDatatoIndexedDB, getDataFromIndexedDB, getAllDataFromIndexedDB ---


        // Import Functionality (Phase 2) - same as before
        importButton.addEventListener('click', () => {
            fileInput.click();
        });

        importGoogleSheetButton.addEventListener('click', () => {
            fetchDataFromGoogleSheet(GOOGLE_SHEET_CSV_URL); // Use constant here
        });

        fileInput.addEventListener('change', handleFileImport);


        async function fetchDataFromGoogleSheet(url) {
            const directURL = url; // Use direct URL now

            try {
                const response = await fetch(directURL); // Use direct URL
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                if (parsedData && parsedData.data.length > 0) {
                    await processGoogleSheetCSVData(parsedData.headers, parsedData.data);
                    showAlert('Data imported from Google Sheet successfully!'); // Using showAlert
                     renderEnteredRecords();
                    updateViewButtonState();
                } else {
                    showAlert('No data found in Google Sheet or error parsing data.'); // showAlert
                     loadDataFromLocalStorage(); // Fallback to local storage load
                }
            } catch (error) {
                console.error("Error importing from Google Sheet:", error);
                showAlert('Failed to import data from Google Sheet. Please check the URL and ensure the sheet is published to the web as CSV. (CORS issue might exist if direct URL is not configured for CORS)', true); // Using showAlert for errors
                loadDataFromLocalStorage(); // Fallback to local storage load
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 1) return { headers: [], data: [] };

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',').map(cell => cell.trim());
                if(row.length > 0 && row[0] !== ""){
                   data.push(row);
                 }
            }

            return { headers: headers, data: data };
        }


        async function processGoogleSheetCSVData(headers, data) {
             if (headers.length === 0) {
                showAlert("Could not parse headers from Google Sheet CSV. Ensure the first row contains headers."); // Using showAlert
                return;
            }

             headers.forEach((header, index) => {
                if(header && header.toLowerCase().includes(BARCODE_HEADER_KEY)) {
                  barcodeHeader = header;
                }
                if(header && header.toLowerCase().includes(NAME_HEADER_KEY)){
                  nameHeader = header
                }
                 headerMap[header] = index;
            });

             if (!barcodeHeader) {
                 showAlert(`No '${BARCODE_HEADER_KEY}' column found in the Google Sheet CSV.`); // Using showAlert
                 return;
             }
             if (!nameHeader){
                 showAlert(`No '${NAME_HEADER_KEY}' column found in the Google Sheet CSV.`); // Using showAlert
                 return;
             }

            database = data;
            localStorage.setItem(DATABASE_STORAGE_KEY, JSON.stringify(database)); // Store database to localStorage
            localStorage.setItem(BARCODE_HEADER_STORAGE_KEY, barcodeHeader);
            localStorage.setItem(NAME_HEADER_STORAGE_KEY, nameHeader);
             updateViewButtonState();

        }


        async function handleFileImport(event) {
             try {
                const file = event.target.files[0];
                if (!file) {
                    showAlert('No file selected!'); // Using showAlert
                    return;
                }

                const allowedFileTypes = ['.xlsx', '.xls'];
                const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
                if (!allowedFileTypes.includes(fileExtension)) {
                    showAlert('Invalid file type. Please select an Excel file (.xlsx or .xls).'); // Using showAlert
                    return;
                }

                 const reader = new FileReader();
                 reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        let workbook;
                        try{
                            workbook = XLSX.read(data, { type: 'array' });
                        }catch(e){
                            console.error("Error parsing file:", e)
                            showAlert('Error parsing file, please check the file format!', true); // Using showAlert for errors
                            return;
                        }
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const range = XLSX.utils.decode_range(worksheet['!ref']);
                         if(range.e.r <1){
                            showAlert("File contains no data!"); // Using showAlert
                            return;
                        }
                        const excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        if (!excelData || excelData.length === 0) {
                            showAlert('File is empty or unreadable!'); // Using showAlert
                            return;
                        }

                        const headers = excelData[0];
                        headers.forEach((header, index) => {
                            if(header && header.toLowerCase().includes(BARCODE_HEADER_KEY)) {
                              barcodeHeader = header;
                            }
                            if(header && header.toLowerCase().includes(NAME_HEADER_KEY)){
                              nameHeader = header
                            }
                             headerMap[header] = index;
                        });

                         if (!barcodeHeader) {
                             showAlert(`No '${BARCODE_HEADER_KEY}' column found in the file.`); // Using showAlert
                             return;
                         }
                         if (!nameHeader){
                             showAlert(`No '${NAME_HEADER_KEY}' column found in the file.`); // Using showAlert
                             return;
                         }


                        database = excelData.slice(1);
                        localStorage.setItem(DATABASE_STORAGE_KEY, JSON.stringify(database)); // Store database to localStorage
                        localStorage.setItem(BARCODE_HEADER_STORAGE_KEY, barcodeHeader);
                        localStorage.setItem(NAME_HEADER_STORAGE_KEY, nameHeader);


                            showAlert('Data imported successfully!'); // Using showAlert
                            renderEnteredRecords();
                            updateViewButtonState();


                    } catch (e) {
                       console.error("Error parsing file:", e)
                        showAlert('Error parsing file, please check the file format!', true); // Using showAlert for errors
                    }
                 };

                 reader.onerror = (e) =>{
                     console.error("Error reading file:", e)
                        showAlert('Error reading file, please check the file format!', true); // Using showAlert for errors
                };

                 reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error during import:", error);
                showAlert('An unexpected error occurred during file import.', true); // Using showAlert for errors
            }
        }

       // Search Functionality (Phase 3) - same search functionality as before
        searchButton.addEventListener('click', () => {
            // ... rest of searchButton event listener - same as before ...
        });

         function renderSearchResultTable(foundItem) { // same render search result table function as before
           // ... rest of renderSearchResultTable function - same as before ...
        }

        // Expiry Date Management (Phase 4) - same expiry date management as before
        addExpiryButton.addEventListener('click', addExpiryEntry);

        function addExpiryEntry() {
            // ... (rest of addExpiryEntry function - same as before) ...
        }


          function isValidDate(dateString){ // same date validation function as before
          // ... (rest of isValidDate function - same as before) ...
        }


        // Save Entry (Phase 5) - Main Save Button (Now Visible and used for all entries) - same save entry function as before
          saveButton.addEventListener('click', () => {
             // ... rest of saveButton event listener - same as before ...
          });

        // Clear Functions (Phase 6) - same clear functions as before
        clearFieldsButton.addEventListener('click', clearFields);

        function clearFields() {
            // ... rest of clearFields function - same as before ...
        }

        clearDatabaseButton.addEventListener('click', clearDatabase);

          async function clearDatabase() {
            // ... rest of clearDatabase function - same as before ...
         }


        // Render Table & List Box (Phase 7) - same render table and list box function as before


           function renderEnteredRecords() {
            // ... rest of renderEnteredRecords function - same as before ...
        }


        async function renderDataList(){ // Modified to load data from localStorage
             // ... rest of renderDataList function - same as before ...
        }


        // Export Data (Phase 8) - same export data function as before
        exportButton.addEventListener('click', () => {
            // ... rest of exportButton event listener - same as before ...
        });

       viewDataButton.addEventListener('click', () =>{ // same view data button function as before
            // ... rest of viewDataButton event listener - same as before ...
        });


        closePopup.addEventListener('click', () => { // same close popup function as before
            // ... rest of closePopup event listener - same as before ...
        });

          window.addEventListener('click', (event) => { // same window click event listener as before
            // ... rest of window click event listener - same as before ...
        });

        searchBarcodeInput.addEventListener('input', (e) => {
            // ... rest of searchBarcodeInput event listener - same as before ...
        });


        function showAlert(message, isError = false) { // Centralized alert function
            // ... rest of showAlert function - same as before ...
        }


        async function autoLoadDatabaseFromGoogleSheet() { // Renamed for clarity and to indicate Google Sheet source
            let databaseURL = GOOGLE_SHEET_CSV_URL; // Use the constant

            console.log("Auto-loading database from Google Sheet CSV URL:", databaseURL);

            try {
                const response = await fetch(databaseURL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const parsedData = parseCSV(csvText); // Reuse your parseCSV function from Inventory Manager

                if (parsedData && parsedData.data.length > 0) { // Use .data for your parseCSV output structure
                    await processGoogleSheetCSVData(parsedData.headers, parsedData.data); // Reuse your processGoogleSheetCSVData
                    showAlert('Database auto-loaded from Google Sheet successfully!'); // Use showAlert
                } else {
                    showAlert('No data found in Google Sheet or error parsing data during auto-load.'); // Use showAlert
                }
            } catch (error) {
                console.error('Error auto-loading database from Google Sheet:', error);
                showAlert(`Error auto-loading database from Google Sheet: ${error.message}`, true); // Use showAlert for errors
                // Fallback to loading from local storage if auto-load fails
                loadDataFromLocalStorage();
            }
        }


        async function init() {
            await autoLoadDatabaseFromGoogleSheet(); // Try to auto-load from Google Sheet first
            await loadDataFromLocalStorage(); // Then load from localStorage for other data
        }


        window.onload = function () {
            init(); // Call init which will handle auto-loading and loading from storage
        };
    </script>
</body>
</html>
